[build]
  command = "pnpm install --frozen-lockfile && pnpm run prisma:generate && pnpm run build"
  publish = ".next"

[build.environment]
  NODE_VERSION = "20"
  PNPM_VERSION = "9"
  # Desabilita smart detection para Firebase API Key (pública por natureza)
  SECRETS_SCAN_SMART_DETECTION_ENABLED = "false"
  # Limita quais env vars vão para as Lambdas; exclui as chaves Firebase (usadas só no build)
  NEXT_PRIVATE_ENV_ALLOWLIST = "APP_URL,CRON_SECRET,DATABASE_URL,EMAIL_FROM,GESTAO_CLIENTES_WEBHOOK_SECRET,INSTAGRAM_APP_ID,INSTAGRAM_APP_SECRET,INSTAGRAM_REDIRECT_URI,NEXT_PUBLIC_APP_URL,NEXT_PUBLIC_FIREBASE_API_KEY,NEXT_PUBLIC_FIREBASE_APP_ID,NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,NEXT_PUBLIC_FIREBASE_PROJECT_ID,NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,NEXT_PUBLIC_MESSAGES_GATEWAY,NEXT_PUBLIC_WHATSAPP_CONTACT_NUMBER,NEXT_PUBLIC_WHATSAPP_INTERNAL_NUMBER,REDIS_URL,RESEND_API_KEY,SENTRY_AUTH_TOKEN,STORAGE_ACCESS_KEY_ID,STORAGE_BUCKET,STORAGE_ENDPOINT,STORAGE_REGION,STORAGE_SECRET_ACCESS_KEY,USE_S3,WHATSAPP_WEBHOOK_SECRET,NODE_VERSION,PNPM_VERSION,SECRETS_SCAN_SMART_DETECTION_ENABLED"
  # Firebase credentials - APENAS para build-time (não passadas ao runtime)
  # Em produção, use Netlify Blobs via getFirebaseCredentials() async
  # Nota: Estas variáveis devem ser definidas via Netlify Dashboard com escopo "builds" somente
  # FIREBASE_PRIVATE_KEY = "definir no Netlify Dashboard"
  # FIREBASE_CLIENT_EMAIL = "definir no Netlify Dashboard"

[scheduled.functions]
  # Daily reconciliation at 02:00 UTC
  finance_reconcile_daily = { schedule = "0 2 * * *" }
  # Daily summary cache at 02:10 UTC
  finance_summary_daily = { schedule = "10 2 * * *" }
  # Monthly projection on the 25th at 02:20 UTC
  finance_projection_monthly = { schedule = "20 2 25 * *" }

# Headers definidos em public/_headers (apenas security headers básicos)
# CSP gerenciado pelo middleware Next.js (src/proxy.ts) para evitar conflitos com Netlify plugin

# Redirects básicos
[[redirects]]
  from = "/health"
  to = "/api/health"
  status = 200

[[plugins]]
  package = "@netlify/plugin-nextjs"

# Edge Function nativo do Netlify (substitui middleware Next.js)
[[edge_functions]]
  function = "middleware"
  path = "/*"
