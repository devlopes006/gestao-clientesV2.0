generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  name           String?
  createdAt      DateTime        @default(now())
  firebaseUid    String          @unique
  image          String?
  updatedAt      DateTime        @updatedAt
  lastActiveAt   DateTime?
  client         Client?
  memberships    Member[]
  notifications  Notification[]
  orgs           Org[]           @relation("OrgOwner")
  firestoreSyncs FirestoreSync[]
}

model Org {
  id                      String                   @id @default(cuid())
  name                    String
  createdAt               DateTime                 @default(now())
  description             String?
  ownerId                 String
  updatedAt               DateTime                 @updatedAt
  addressLine1            String?
  addressLine2            String?
  city                    String?
  cnpj                    String?
  country                 String?
  phone                   String?
  postalCode              String?
  state                   String?
  website                 String?
  clients                 Client[]
  clientCostSubscriptions ClientCostSubscription[]
  costItems               CostItem[]
  dashboardEvents         DashboardEvent[]
  dashboardNotes          DashboardNote[]
  invites                 Invite[]
  invoices                Invoice[]
  media                   Media[]
  members                 Member[]
  notifications           Notification[]
  owner                   User                     @relation("OrgOwner", fields: [ownerId], references: [id])
  recurringExpenses       RecurringExpense[]
  tasks                   Task[]
  transactions            Transaction[]
  whatsappMessages        WhatsAppMessage[]
}

model Member {
  id        String   @id @default(cuid())
  role      Role
  userId    String
  orgId     String
  createdAt DateTime @default(now())
  isActive  Boolean  @default(true)
  org       Org      @relation(fields: [orgId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, orgId])
}

model Client {
  id                      String                   @id @default(cuid())
  name                    String
  email                   String?
  orgId                   String
  createdAt               DateTime                 @default(now())
  phone                   String?
  updatedAt               DateTime                 @updatedAt
  status                  String                   @default("new")
  clientUserId            String?                  @unique
  contractEnd             DateTime?
  contractStart           DateTime?
  contractValue           Float?
  paymentDay              Int?
  paymentStatus           PaymentStatus            @default(PENDING)
  mainChannel             SocialChannel?
  plan                    ClientPlan?
  installmentCount        Int?
  installmentValue        Float?
  isInstallment           Boolean                  @default(false)
  instagramUserId         String?
  instagramUsername       String?
  instagramAccessToken    String?
  instagramTokenExpiresAt DateTime?
  installmentPaymentDays  Int[]                    @default([])
  cnpj                    String?                  @unique
  cpf                     String?                  @unique
  deletedAt               DateTime?
  deletedBy               String?
  brandings               Branding[]
  clientUser              User?                    @relation(fields: [clientUserId], references: [id])
  org                     Org                      @relation(fields: [orgId], references: [id])
  clientCostSubscriptions ClientCostSubscription[]
  installments            Installment[]
  invites                 Invite[]
  invoices                Invoice[]
  media                   Media[]
  mediaFolders            MediaFolder[]
  meetings                Meeting[]
  strategies              Strategy[]
  tasks                   Task[]
  transactions            Transaction[]
  whatsappMessages        WhatsAppMessage[]

  @@index([orgId, status])
  @@index([orgId, createdAt])
  @@index([email])
  @@index([cpf])
  @@index([cnpj])
  @@index([orgId, plan])
  @@index([orgId, mainChannel])
  @@index([orgId, paymentStatus])
  @@index([deletedAt])
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  clientId    String
  createdAt   DateTime     @default(now())
  orgId       String
  updatedAt   DateTime     @updatedAt
  assignee    String?
  dueDate     DateTime?
  priority    TaskPriority @default(MEDIUM)
  deletedAt   DateTime?
  deletedBy   String?
  client      Client       @relation(fields: [clientId], references: [id])
  org         Org          @relation(fields: [orgId], references: [id])

  @@index([clientId, status])
  @@index([orgId, dueDate])
  @@index([orgId, status, dueDate])
  @@index([assignee, status])
  @@index([deletedAt])
}

model Media {
  id          String       @id @default(cuid())
  url         String?
  type        String
  clientId    String
  createdAt   DateTime     @default(now())
  orgId       String
  description String?
  title       String
  updatedAt   DateTime     @updatedAt
  fileKey     String?
  fileSize    Int?
  folderId    String?
  mimeType    String?
  metadata    Json?
  tags        String[]     @default([])
  thumbUrl    String?
  client      Client       @relation(fields: [clientId], references: [id])
  folder      MediaFolder? @relation(fields: [folderId], references: [id])
  org         Org          @relation(fields: [orgId], references: [id])

  @@index([clientId, folderId])
  @@index([tags])
}

model MediaFolder {
  id          String        @id @default(cuid())
  name        String
  description String?
  parentId    String?
  clientId    String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  media       Media[]
  client      Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  parent      MediaFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    MediaFolder[] @relation("FolderHierarchy")

  @@index([clientId, parentId])
}

model Invite {
  id            String       @id @default(cuid())
  orgId         String
  email         String
  roleRequested Role
  token         String       @unique
  status        InviteStatus @default(PENDING)
  type          InviteType   @default(TEAM_INVITE)
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  clientId      String?
  clientName    String?
  client        Client?      @relation(fields: [clientId], references: [id])
  org           Org          @relation(fields: [orgId], references: [id])
}

model FirestoreSync {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String
  data      Json
  status    String   @default("PENDING")
  attempts  Int      @default(0)
  lastError String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Strategy {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String
  content     String
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Branding {
  id          String   @id @default(cuid())
  title       String
  type        String
  description String?
  fileUrl     String?
  content     String?
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  thumbUrl    String?
  palette     Json?
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model CostItem {
  id            String                   @id @default(cuid())
  name          String
  description   String?
  amount        Float
  category      String?
  active        Boolean                  @default(true)
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  orgId         String
  subscriptions ClientCostSubscription[]
  org           Org                      @relation(fields: [orgId], references: [id])
  transactions  Transaction[]

  @@index([orgId, active])
}

model ClientCostSubscription {
  id         String    @id @default(cuid())
  clientId   String
  costItemId String
  startDate  DateTime
  endDate    DateTime?
  active     Boolean   @default(true)
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  orgId      String
  createdBy  String?
  deletedAt  DateTime?
  deletedBy  String?
  updatedBy  String?
  client     Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  costItem   CostItem  @relation(fields: [costItemId], references: [id])
  org        Org       @relation(fields: [orgId], references: [id])

  @@unique([clientId, costItemId, startDate])
  @@index([orgId, active])
  @@index([clientId, active])
  @@index([deletedAt])
}

model Meeting {
  id          String   @id @default(cuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  status      String   @default("scheduled")
  notes       String?
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Installment {
  id        String        @id @default(cuid())
  number    Int
  amount    Float
  dueDate   DateTime
  status    PaymentStatus @default(PENDING)
  paidAt    DateTime?
  notes     String?
  clientId  String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoices  Invoice?

  @@index([clientId, dueDate])
}

model Transaction {
  id          String             @id @default(cuid())
  type        TransactionType
  subtype     TransactionSubtype
  amount      Float
  description String?
  category    String?
  date        DateTime           @default(now())
  status      TransactionStatus  @default(CONFIRMED)
  invoiceId   String?
  clientId    String?
  costItemId  String?
  metadata    Json?
  createdAt   DateTime           @default(now())
  createdBy   String?
  updatedAt   DateTime           @updatedAt
  updatedBy   String?
  deletedAt   DateTime?
  deletedBy   String?
  orgId       String
  client      Client?            @relation(fields: [clientId], references: [id])
  costItem    CostItem?          @relation(fields: [costItemId], references: [id])
  invoice     Invoice?           @relation(fields: [invoiceId], references: [id])
  org         Org                @relation(fields: [orgId], references: [id])

  @@index([orgId, date])
  @@index([orgId, type, date])
  @@index([clientId, date])
  @@index([invoiceId])
  @@index([orgId, status])
  @@index([deletedAt])
  @@index([orgId, costItemId, date])
  @@index([orgId, subtype, date])
}

model Invoice {
  id            String        @id @default(cuid())
  orgId         String
  clientId      String
  number        String        @unique
  status        InvoiceStatus @default(OPEN)
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  currency      String        @default("BRL")
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  installmentId String?       @unique
  cancelledAt   DateTime?
  createdBy     String?
  deletedAt     DateTime?
  deletedBy     String?
  internalNotes String?
  paidAt        DateTime?
  updatedBy     String?
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  installment   Installment?  @relation(fields: [installmentId], references: [id])
  org           Org           @relation(fields: [orgId], references: [id])
  items         InvoiceItem[]
  transactions  Transaction[]

  @@index([orgId, clientId, status])
  @@index([orgId, dueDate])
  @@index([clientId, status])
  @@index([deletedAt])
  @@index([orgId, status, dueDate])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int      @default(1)
  unitAmount  Float
  total       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model RecurringExpense {
  id          String       @id @default(cuid())
  name        String
  description String?
  amount      Float
  category    String?
  cycle       ExpenseCycle @default(MONTHLY)
  dayOfMonth  Int?
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  createdBy   String?
  updatedAt   DateTime     @updatedAt
  updatedBy   String?
  deletedAt   DateTime?
  deletedBy   String?
  orgId       String
  org         Org          @relation(fields: [orgId], references: [id])

  @@index([orgId, active])
  @@index([deletedAt])
  @@index([orgId, cycle, active])
}

model WebhookEvent {
  id         String   @id @default(cuid())
  provider   String
  eventType  String
  payload    Json
  receivedAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  orgId     String?
  userId    String?
  type      String
  title     String
  message   String?
  link      String?
  clientId  String?
  priority  String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  org       Org?     @relation(fields: [orgId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId, orgId])
}

model DashboardEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime
  color       String?  @default("blue")
  orgId       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, date])
}

model DashboardNote {
  id        String   @id @default(cuid())
  title     String
  content   String
  color     String?  @default("yellow")
  position  Int      @default(0)
  orgId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, position])
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionSubtype {
  INVOICE_PAYMENT
  OTHER_INCOME
  INTERNAL_COST
  FIXED_EXPENSE
  OTHER_EXPENSE
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  OVERDUE
  CANCELLED
}

enum ExpenseCycle {
  MONTHLY
  ANNUAL
}

enum Role {
  OWNER
  STAFF
  CLIENT
}

enum InviteStatus {
  PENDING
  ACCEPTED
  CANCELED
  EXPIRED
}

enum InviteType {
  TEAM_INVITE
  CLIENT_INVITE
  CLIENT_CREATE
}

enum ClientPlan {
  GESTAO
  ESTRUTURA
  FREELANCER
  PARCERIA
  CONSULTORIA
  OUTRO
}

enum SocialChannel {
  INSTAGRAM
  FACEBOOK
  TIKTOK
  YOUTUBE
  LINKEDIN
  TWITTER
  OUTRO
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  LATE
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model WhatsAppMessage {
  id          String   @id @default(cuid())
  messageId   String?  @unique
  event       String // 'message' | 'status'
  from        String?
  to          String?
  recipientId String?
  name        String?
  type        String? // 'text' | 'image' | 'video' | 'document' | 'audio'
  text        String?
  mediaUrl    String?
  timestamp   DateTime @default(now())
  status      String? // 'sent' | 'delivered' | 'read' | 'failed'
  isRead      Boolean  @default(false) // Marca se a mensagem foi lida
  orgId       String?
  clientId    String?
  metadata    Json? // Dados adicionais flex√≠veis
  createdAt   DateTime @default(now())

  org    Org?    @relation(fields: [orgId], references: [id])
  client Client? @relation(fields: [clientId], references: [id])

  @@index([from])
  @@index([to])
  @@index([timestamp])
  @@index([orgId])
  @@index([isRead])
}
