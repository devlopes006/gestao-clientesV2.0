generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String?
  createdAt     DateTime       @default(now())
  firebaseUid   String         @unique
  image         String?
  updatedAt     DateTime       @updatedAt
  lastActiveAt  DateTime?
  client        Client?
  memberships   Member[]
  notifications Notification[]
  orgs          Org[]          @relation("OrgOwner")
}

model Org {
  id            String         @id @default(cuid())
  name          String
  createdAt     DateTime       @default(now())
  description   String?
  ownerId       String
  updatedAt     DateTime       @updatedAt
  addressLine1  String?
  addressLine2  String?
  city          String?
  cnpj          String?
  country       String?
  phone         String?
  postalCode    String?
  state         String?
  website       String?
  clients       Client[]
  finances      Finance[]
  invites       Invite[]
  invoices      Invoice[]
  media         Media[]
  members       Member[]
  notifications Notification[]
  owner         User           @relation("OrgOwner", fields: [ownerId], references: [id])
  payments      Payment[]
  subscriptions Subscription[]
  tasks         Task[]
}

model Member {
  id        String   @id @default(cuid())
  role      Role
  userId    String
  orgId     String
  createdAt DateTime @default(now())
  isActive  Boolean  @default(true)
  org       Org      @relation(fields: [orgId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, orgId])
}

model Client {
  id                      String         @id @default(cuid())
  name                    String
  email                   String?
  orgId                   String
  createdAt               DateTime       @default(now())
  phone                   String?
  updatedAt               DateTime       @updatedAt
  status                  String         @default("new")
  clientUserId            String?        @unique
  contractEnd             DateTime?
  contractStart           DateTime?
  contractValue           Float?
  paymentDay              Int?
  paymentStatus           PaymentStatus  @default(PENDING)
  mainChannel             SocialChannel?
  plan                    ClientPlan?
  installmentCount        Int?
  installmentValue        Float?
  isInstallment           Boolean        @default(false)
  installmentPaymentDays  Int[]          @default([])
  instagramUserId         String?
  instagramUsername       String?
  instagramAccessToken    String?
  instagramTokenExpiresAt DateTime?
  brandings               Branding[]
  clientUser              User?          @relation(fields: [clientUserId], references: [id])
  org                     Org            @relation(fields: [orgId], references: [id])
  finances                Finance[]
  installments            Installment[]
  invites                 Invite[]
  invoices                Invoice[]
  media                   Media[]
  mediaFolders            MediaFolder[]
  meetings                Meeting[]
  payments                Payment[]
  strategies              Strategy[]
  subscriptions           Subscription[]
  tasks                   Task[]

  @@index([orgId, status])
  @@index([orgId, createdAt])
  @@index([email])
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  status      String    @default("todo")
  clientId    String
  createdAt   DateTime  @default(now())
  orgId       String
  updatedAt   DateTime  @updatedAt
  assignee    String?
  dueDate     DateTime?
  priority    String    @default("medium")
  client      Client    @relation(fields: [clientId], references: [id])
  org         Org       @relation(fields: [orgId], references: [id])

  @@index([clientId, status])
  @@index([orgId, dueDate])
}

model Media {
  id          String       @id @default(cuid())
  url         String?
  type        String
  clientId    String
  createdAt   DateTime     @default(now())
  orgId       String
  description String?
  title       String
  updatedAt   DateTime     @updatedAt
  fileKey     String?
  fileSize    Int?
  folderId    String?
  mimeType    String?
  metadata    Json?
  tags        String[]     @default([])
  thumbUrl    String?
  client      Client       @relation(fields: [clientId], references: [id])
  folder      MediaFolder? @relation(fields: [folderId], references: [id])
  org         Org          @relation(fields: [orgId], references: [id])

  @@index([clientId, folderId])
  @@index([tags])
}

model MediaFolder {
  id          String        @id @default(cuid())
  name        String
  description String?
  parentId    String?
  clientId    String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  media       Media[]
  client      Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  parent      MediaFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    MediaFolder[] @relation("FolderHierarchy")

  @@index([clientId, parentId])
}

model Invite {
  id            String       @id @default(cuid())
  orgId         String
  email         String
  roleRequested Role
  token         String       @unique
  status        InviteStatus @default(PENDING)
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  clientId      String?
  client        Client?      @relation(fields: [clientId], references: [id])
  org           Org          @relation(fields: [orgId], references: [id])
}

model Strategy {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String
  content     String
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Branding {
  id          String   @id @default(cuid())
  title       String
  type        String
  description String?
  fileUrl     String?
  content     String?
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  thumbUrl    String?
  palette     Json?
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Finance {
  id          String   @id @default(cuid())
  type        String
  amount      Float
  description String?
  category    String?
  date        DateTime @default(now())
  clientId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orgId       String
  client      Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  org         Org      @relation(fields: [orgId], references: [id])

  @@index([orgId, date])
  @@index([clientId, date])
}

model Meeting {
  id          String   @id @default(cuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  status      String   @default("scheduled")
  notes       String?
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Installment {
  id        String        @id @default(cuid())
  number    Int
  amount    Float
  dueDate   DateTime
  status    PaymentStatus @default(PENDING)
  paidAt    DateTime?
  notes     String?
  clientId  String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, dueDate])
}

model Subscription {
  id                 String             @id @default(cuid())
  orgId              String
  clientId           String
  status             SubscriptionStatus @default(ACTIVE)
  planName           String
  unitAmount         Float
  currency           String             @default("BRL")
  interval           BillingInterval    @default(MONTH)
  trialEndsAt        DateTime?
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean            @default(false)
  canceledAt         DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  invoices           Invoice[]
  client             Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  org                Org                @relation(fields: [orgId], references: [id])

  @@index([orgId, clientId])
}

model Invoice {
  id             String        @id @default(cuid())
  orgId          String
  clientId       String
  subscriptionId String?
  number         String        @unique
  status         InvoiceStatus @default(DRAFT)
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  subtotal       Float         @default(0)
  discount       Float         @default(0)
  tax            Float         @default(0)
  total          Float         @default(0)
  currency       String        @default("BRL")
  notes          String?
  externalId     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  org            Org           @relation(fields: [orgId], references: [id])
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  items          InvoiceItem[]
  payments       Payment[]

  @@index([orgId, clientId, status])
  @@index([orgId, dueDate])
  @@index([clientId, status])
  @@index([subscriptionId])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitAmount  Float
  total       Float
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Payment {
  id                String    @id @default(cuid())
  orgId             String
  clientId          String
  invoiceId         String
  amount            Float
  method            String
  status            String    @default("PAID")
  paidAt            DateTime?
  provider          String?
  providerPaymentId String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  client            Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoice           Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  org               Org       @relation(fields: [orgId], references: [id])
}

model WebhookEvent {
  id         String   @id @default(cuid())
  provider   String
  eventType  String
  payload    Json
  receivedAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  orgId     String?
  userId    String?
  type      String
  title     String
  message   String?
  link      String?
  clientId  String?
  priority  String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  org       Org?     @relation(fields: [orgId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId, orgId])
}

enum Role {
  OWNER
  STAFF
  CLIENT
}

enum InviteStatus {
  PENDING
  ACCEPTED
  CANCELED
  EXPIRED
}

enum ClientPlan {
  GESTAO
  ESTRUTURA
  FREELANCER
  PARCERIA
  CONSULTORIA
  OUTRO
}

enum SocialChannel {
  INSTAGRAM
  FACEBOOK
  TIKTOK
  YOUTUBE
  LINKEDIN
  TWITTER
  OUTRO
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  LATE
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  OVERDUE
  CANCELED
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  INACTIVE
}

enum BillingInterval {
  MONTH
  YEAR
}
